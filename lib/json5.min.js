// Simple JSON5 parser - supports unquoted keys, trailing commas, single quotes
(function(global) {
    'use strict';

    var JSON5 = {};

    JSON5.parse = function(text) {
        var at = 0;
        var ch = ' ';
        var escapee = {
            '"': '"',
            "'": "'",
            '\\': '\\',
            '/': '/',
            b: '\b',
            f: '\f',
            n: '\n',
            r: '\r',
            t: '\t'
        };

        function error(m) {
            throw new SyntaxError(m + ' at position ' + at);
        }

        function next(c) {
            if (c && c !== ch) {
                error("Expected '" + c + "' instead of '" + ch + "'");
            }
            ch = text.charAt(at);
            at += 1;
            return ch;
        }

        function white() {
            while (ch && ch <= ' ') {
                next();
            }
            // Skip comments
            if (ch === '/') {
                next();
                if (ch === '/') {
                    while (ch && ch !== '\n') {
                        next();
                    }
                    white();
                } else if (ch === '*') {
                    next();
                    while (ch) {
                        if (ch === '*') {
                            next();
                            if (ch === '/') {
                                next();
                                break;
                            }
                        } else {
                            next();
                        }
                    }
                    white();
                } else {
                    error('Unexpected character');
                }
            }
        }

        function word() {
            switch (ch) {
                case 't':
                    next('t'); next('r'); next('u'); next('e');
                    return true;
                case 'f':
                    next('f'); next('a'); next('l'); next('s'); next('e');
                    return false;
                case 'n':
                    next('n'); next('u'); next('l'); next('l');
                    return null;
                case 'u':
                    next('u'); next('n'); next('d'); next('e'); next('f'); next('i'); next('n'); next('e'); next('d');
                    return undefined;
                case 'N':
                    next('N'); next('a'); next('N');
                    return NaN;
                case 'I':
                    next('I'); next('n'); next('f'); next('i'); next('n'); next('i'); next('t'); next('y');
                    return Infinity;
            }
            error("Unexpected '" + ch + "'");
        }

        function number() {
            var string = '';
            if (ch === '-' || ch === '+') {
                string = ch;
                next();
            }
            if (ch === '0') {
                string += ch;
                next();
                if (ch === 'x' || ch === 'X') {
                    string += ch;
                    next();
                    while ((ch >= '0' && ch <= '9') || (ch >= 'a' && ch <= 'f') || (ch >= 'A' && ch <= 'F')) {
                        string += ch;
                        next();
                    }
                    return parseInt(string, 16);
                }
            }
            while (ch >= '0' && ch <= '9') {
                string += ch;
                next();
            }
            if (ch === '.') {
                string += '.';
                while (next() && ch >= '0' && ch <= '9') {
                    string += ch;
                }
            }
            if (ch === 'e' || ch === 'E') {
                string += ch;
                next();
                if (ch === '-' || ch === '+') {
                    string += ch;
                    next();
                }
                while (ch >= '0' && ch <= '9') {
                    string += ch;
                    next();
                }
            }
            return +string;
        }

        function string() {
            var quote = ch;
            var string = '';
            var hex;
            var uffff;

            if (ch !== '"' && ch !== "'") {
                error('Bad string');
            }

            while (next()) {
                if (ch === quote) {
                    next();
                    return string;
                }
                if (ch === '\\') {
                    next();
                    if (ch === 'u') {
                        uffff = 0;
                        for (var i = 0; i < 4; i++) {
                            hex = parseInt(next(), 16);
                            if (!isFinite(hex)) {
                                break;
                            }
                            uffff = uffff * 16 + hex;
                        }
                        string += String.fromCharCode(uffff);
                    } else if (ch === '\r') {
                        if (text.charAt(at) === '\n') {
                            next();
                        }
                    } else if (ch === '\n') {
                        // Line continuation
                    } else if (typeof escapee[ch] === 'string') {
                        string += escapee[ch];
                    } else {
                        string += ch;
                    }
                } else if (ch === '\n' || ch === '\r') {
                    error('Bad string');
                } else {
                    string += ch;
                }
            }
            error('Bad string');
        }

        function identifier() {
            var string = '';
            if ((ch >= 'a' && ch <= 'z') || (ch >= 'A' && ch <= 'Z') || ch === '_' || ch === '$') {
                string += ch;
                while (next() && ((ch >= 'a' && ch <= 'z') || (ch >= 'A' && ch <= 'Z') || (ch >= '0' && ch <= '9') || ch === '_' || ch === '$')) {
                    string += ch;
                }
                return string;
            }
            error('Bad identifier');
        }

        function array() {
            var array = [];
            if (ch !== '[') {
                error('Bad array');
            }
            next('[');
            white();
            if (ch === ']') {
                next(']');
                return array;
            }
            while (ch) {
                array.push(value());
                white();
                if (ch === ']') {
                    next(']');
                    return array;
                }
                next(',');
                white();
                // Allow trailing comma
                if (ch === ']') {
                    next(']');
                    return array;
                }
            }
            error('Bad array');
        }

        function object() {
            var object = {};
            var key;

            if (ch !== '{') {
                error('Bad object');
            }
            next('{');
            white();
            if (ch === '}') {
                next('}');
                return object;
            }
            while (ch) {
                // Key can be quoted string or unquoted identifier
                if (ch === '"' || ch === "'") {
                    key = string();
                } else {
                    key = identifier();
                }
                white();
                next(':');
                object[key] = value();
                white();
                if (ch === '}') {
                    next('}');
                    return object;
                }
                next(',');
                white();
                // Allow trailing comma
                if (ch === '}') {
                    next('}');
                    return object;
                }
            }
            error('Bad object');
        }

        function value() {
            white();
            switch (ch) {
                case '{':
                    return object();
                case '[':
                    return array();
                case '"':
                case "'":
                    return string();
                case '-':
                case '+':
                case '.':
                    return number();
                default:
                    return (ch >= '0' && ch <= '9') ? number() : word();
            }
        }

        var result = value();
        white();
        if (ch) {
            error('Unexpected character');
        }
        return result;
    };

    // Stringify with unquoted keys (JSON5 style)
    JSON5.stringify = function(value, replacer, space) {
        var indent = '';
        var gap = '';
        
        if (typeof space === 'number') {
            for (var i = 0; i < space; i++) {
                gap += ' ';
            }
        } else if (typeof space === 'string') {
            gap = space;
        }

        function isIdentifier(key) {
            return /^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(key);
        }

        function stringify(value, currentIndent) {
            if (value === null) return 'null';
            if (value === undefined) return 'undefined';
            if (typeof value === 'boolean') return value ? 'true' : 'false';
            if (typeof value === 'number') {
                if (isNaN(value)) return 'NaN';
                if (!isFinite(value)) return value > 0 ? 'Infinity' : '-Infinity';
                return String(value);
            }
            if (typeof value === 'string') {
                return '"' + value.replace(/\\/g, '\\\\')
                    .replace(/"/g, '\\"')
                    .replace(/\n/g, '\\n')
                    .replace(/\r/g, '\\r')
                    .replace(/\t/g, '\\t') + '"';
            }
            if (Array.isArray(value)) {
                if (value.length === 0) return '[]';
                var nextIndent = currentIndent + gap;
                var items = value.map(function(v) {
                    return stringify(v, nextIndent);
                });
                if (gap) {
                    return '[\n' + nextIndent + items.join(',\n' + nextIndent) + '\n' + currentIndent + ']';
                }
                return '[' + items.join(',') + ']';
            }
            if (typeof value === 'object') {
                var keys = Object.keys(value);
                if (keys.length === 0) return '{}';
                var nextIndent = currentIndent + gap;
                var pairs = keys.map(function(key) {
                    var keyStr = isIdentifier(key) ? key : '"' + key + '"';
                    return keyStr + ': ' + stringify(value[key], nextIndent);
                });
                if (gap) {
                    return '{\n' + nextIndent + pairs.join(',\n' + nextIndent) + '\n' + currentIndent + '}';
                }
                return '{' + pairs.join(',') + '}';
            }
            return String(value);
        }

        return stringify(value, '');
    };

    // Export
    if (typeof module !== 'undefined' && module.exports) {
        module.exports = JSON5;
    } else {
        global.JSON5 = JSON5;
    }

})(typeof window !== 'undefined' ? window : this);
